generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                       String        @id @default(cuid())
  email                    String        @unique
  password                 String?
  name                     String
  role                     UserRole
  createdAt                DateTime      @default(now()) @map("createdAt")
  updatedAt                DateTime      @updatedAt @map("updatedAt")
  businessId               String
  currentDeviceId          String?       @map("current_device_id")
  currentSessionToken      String?       @map("current_session_token")
  lastLoginAt              DateTime?     @map("last_login_at")
  emailVerificationExpires DateTime?     @map("email_verification_expires")
  emailVerificationToken   String?       @map("email_verification_token")
  isEmailVerified          Boolean       @default(false) @map("is_email_verified")
  oauthProvider            String?       @map("oauth_provider")
  oauthProviderId          String?       @map("oauth_provider_id")
  passwordResetExpires     DateTime?     @map("password_reset_expires")
  passwordResetToken       String?       @map("password_reset_token")
  transactions             Transaction[]
  business                 Business      @relation(fields: [businessId], references: [id])

  @@map("users")
}

model Business {
  id           String        @id @default(cuid())
  name         String
  address      String?
  phone        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  categories   Category[]
  products     Product[]
  transactions Transaction[]
  users        User[]

  @@map("businesses")
}

model Category {
  id          String    @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  businessId  String
  business    Business  @relation(fields: [businessId], references: [id])
  products    Product[]

  @@map("categories")
}

model Product {
  id               String            @id @default(cuid())
  name             String
  description      String?
  price            Decimal           @db.Decimal(10, 2)
  stock            Int               @default(0)
  imageUrl         String?
  status           ProductStatus     @default(AVAILABLE)
  categoryId       String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  businessId       String
  costPrice        Decimal           @default(0) @db.Decimal(10, 2)
  business         Business          @relation(fields: [businessId], references: [id])
  category         Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  transactionItems TransactionItem[]

  @@map("products")
}

model Transaction {
  id                String            @id @default(cuid())
  transactionNumber String            @unique
  userId            String
  totalAmount       Decimal           @db.Decimal(10, 2)
  paymentMethod     PaymentMethod?    @default(CASH)
  paymentAmount     Decimal?          @db.Decimal(10, 2)
  changeAmount      Decimal?          @db.Decimal(10, 2)
  status            TransactionStatus @default(PENDING)
  notes             String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  tableNumber       String?
  businessId        String
  items             TransactionItem[]
  business          Business          @relation(fields: [businessId], references: [id])
  user              User              @relation(fields: [userId], references: [id])

  @@index([createdAt])
  @@index([userId])
  @@index([status])
  @@map("transactions")
}

model TransactionItem {
  id            String      @id @default(cuid())
  transactionId String
  productId     String?
  productName   String
  quantity      Int
  price         Decimal     @db.Decimal(10, 2)
  subtotal      Decimal     @db.Decimal(10, 2)
  costPrice     Decimal     @default(0) @db.Decimal(10, 2)
  product       Product?    @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@map("transaction_items")
}

enum UserRole {
  ADMIN
  KASIR
  BUSINESS_OWNER
}

enum ProductStatus {
  AVAILABLE
  OUT_OF_STOCK
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  QRIS
  TRANSFER
  OTHER
}
